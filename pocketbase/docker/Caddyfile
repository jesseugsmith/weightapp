# Caddyfile for PocketBase
# For local dev/testing
:80 {
    # Reverse proxy to PocketBase
    reverse_proxy pocketbase:8090 {
        # WebSocket support (automatic)
        # Health checks
        health_uri /api/health
        health_interval 30s
        health_timeout 10s
    }

    # Rate limiting
    rate_limit {
        zone api {
            key {remote_host}
            events 600
            window 1m
        }
        zone auth {
            key {remote_host}
            events 30
            window 1m
        }
    }

    # Apply stricter rate limits to auth endpoints
    @auth path /api/collections/users/auth-with-password*
    rate_limit @auth auth

    # Apply rate limits to API
    @api path /api/*
    rate_limit @api api

    # Security headers (automatic but can customize)
    header {
        X-Frame-Options DENY
        X-Content-Type-Options nosniff
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        -Server  # Remove server header
    }

    # CORS for API (if needed)
    @cors_preflight {
        method OPTIONS
        path /api/*
    }
    handle @cors_preflight {
        header Access-Control-Allow-Origin "{http.request.header.Origin}"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
        header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Mx-ReqToken, X-Requested-With"
        header Access-Control-Allow-Credentials "true"
        respond 204
    }

    # Add CORS to API responses
    @api_requests path /api/*
    header @api_requests {
        Access-Control-Allow-Origin "{http.request.header.Origin}"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
        Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Mx-ReqToken, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }

    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# Production with automatic HTTPS
# Uncomment and replace with your domain
# your-domain.com {
#     reverse_proxy pocketbase:8090 {
#         health_uri /api/health
#         health_interval 30s
#         health_timeout 10s
#     }
#
#     # Restrict admin UI to Tailscale (optional)
#     @admin path /_/*
#     handle @admin {
#         # Uncomment to restrict to Tailscale
#         # @tailscale remote_ip 100.64.0.0/10
#         # handle @tailscale {
#         #     reverse_proxy pocketbase:8090
#         # }
#         # respond "Access denied" 403
#         reverse_proxy pocketbase:8090
#     }
#
#     # All other settings from above...
#     # (copy rate limiting, CORS, security headers, etc.)
# }
